//@version=6
indicator("True Trend Engine â€“ Direction Line", shorttitle="TrueTrend Line", overlay=true, max_labels_count=100)

//========================
// 1) Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…: Ø³Ù†ØªØ§Øª / ÙƒØ¨ÙŠØ±Ø©
//========================
group_type      = "ğŸ“Œ Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…"
stock_type      = input.string("ÙƒØ¨ÙŠØ±Ø©", "Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…", options = ["Ø³Ù†ØªØ§Øª", "ÙƒØ¨ÙŠØ±Ø©"], group = group_type)
penny_min_price = input.float(0.5,  "Ø£Ø¯Ù†Ù‰ Ø³Ø¹Ø± Ù„Ø³Ù‡Ù… Ø§Ù„Ø³Ù†ØªØ§Øª", group = group_type)
penny_max_price = input.float(10.0, "Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ù„Ø³Ù‡Ù… Ø§Ù„Ø³Ù†ØªØ§Øª", group = group_type)
large_min_price = input.float(10.0, "Ø£Ø¯Ù†Ù‰ Ø³Ø¹Ø± Ù„Ù„Ø³Ù‡Ù… Ø§Ù„ÙƒØ¨ÙŠØ±",  group = group_type)

isPenny   = close >= penny_min_price and close <= penny_max_price
isLarge   = close >= large_min_price
validType = (stock_type == "Ø³Ù†ØªØ§Øª" and isPenny) or (stock_type == "ÙƒØ¨ÙŠØ±Ø©" and isLarge)

//========================
// 2) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ùˆ Ø¶Ø¨Ø· Ø­Ø³Ø¨ Ø§Ù„ÙØ±ÙŠÙ…
//========================
group_general     = "âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©"
autoAdjustTF      = input.bool(true, "Ø¶Ø¨Ø· Ø§Ù„Ø´Ø±ÙˆØ· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„ÙØ±ÙŠÙ…", group = group_general)
baseTrendLen      = input.int(50, "Ø·ÙˆÙ„ Ø§Ù„ØªØ±Ù†Ø¯ (Ø£Ø³Ø§Ø³)", minval=10, group = group_general)
baseSlowLen       = input.int(200, "Ø·ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¨Ø·ÙŠØ¡ (Ø£Ø³Ø§Ø³)", minval=50, group = group_general)
volLen            = input.int(20, "Ø·ÙˆÙ„ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³ÙŠÙˆÙ„Ø©", minval=5, group = group_general)
strengthLen       = input.int(10, "Ø·ÙˆÙ„ Ù‚ÙŠØ§Ø³ Ù‚ÙˆØ© Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (ROC)", minval=2, group = group_general)
strengthThreshold = input.float(0.3, "Ø£Ø¯Ù†Ù‰ Ù‚ÙˆØ© Ù„Ù„Ø§ØªØ¬Ø§Ù‡ (ROC)", minval=0.05, step=0.05, group = group_general)
useVolFilter      = input.bool(true, "ØªÙØ¹ÙŠÙ„ ÙÙ„ØªØ± Ø§Ù„Ø³ÙŠÙˆÙ„Ø©", group = group_general)

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙØ±ÙŠÙ… Ù„Ø«ÙˆØ§Ù†ÙŠ
tfSec  = timeframe.in_seconds(timeframe.period)
multTF = autoAdjustTF ? (tfSec <= 900 ? 1 : tfSec <= 3600 ? 2 : tfSec <= 86400 ? 3 : 4) : 1

trendLen = baseTrendLen * multTF
slowLen  = baseSlowLen * multTF

//========================
// 3) Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ùˆ Ø§Ù„Ø³ÙŠÙˆÙ„Ø©
//========================
emaFast = ta.ema(close, trendLen)
emaSlow = ta.ema(close, slowLen)
vwmaT   = ta.vwma(close, trendLen)
vwap    = ta.vwap(hlc3)

volMA = ta.sma(volume, volLen)

// Ù…Ù‚ÙŠØ§Ø³ Ù‚ÙˆØ© Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (Ø¨Ø¯ÙŠÙ„ ADX): Ù…ÙŠÙ„ EMA Ø§Ù„Ø³Ø±ÙŠØ¹
trendStrength = math.abs(ta.roc(emaFast, strengthLen))
hasStrongTrend = trendStrength > strengthThreshold

//========================
// 4) Ø´Ø±ÙˆØ· Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
//========================
// ØµØ§Ø¹Ø¯ Ø­Ù‚ÙŠÙ‚ÙŠ
c1_up = emaFast > emaSlow
c2_up = close > emaFast and close > vwap
c3_up = vwmaT > vwmaT[1]
c4_up = hasStrongTrend
c5_up = not useVolFilter or volume > volMA

trueUp = validType and c1_up and c2_up and c3_up and c4_up and c5_up

// Ù‡Ø§Ø¨Ø· Ø­Ù‚ÙŠÙ‚ÙŠ
c1_dn = emaFast < emaSlow
c2_dn = close < emaFast and close < vwap
c3_dn = vwmaT < vwmaT[1]
c4_dn = hasStrongTrend
c5_dn = not useVolFilter or volume > volMA

trueDown = validType and c1_dn and c2_dn and c3_dn and c4_dn and c5_dn

//========================
// 5) Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (1 ØµØ§Ø¹Ø¯ØŒ -1 Ù‡Ø§Ø¨Ø·ØŒ 0 Ù…Ø­Ø§ÙŠØ¯)
//========================
var int trendState = 0
trendState := trueUp ? 1 : trueDown ? -1 : trendState[1]

// Ø®Ø· Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø±Øª (ÙŠÙ„ØªØµÙ‚ Ø¨Ø§Ù„Ø³Ø¹Ø±)
trendPrice = close

trendColor = trendState == 1  ? color.new(color.green, 0) : trendState == -1 ? color.new(color.red,   0) : color.new(color.gray, 60)

plot(trendPrice, title="Ø®Ø· Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ", color=trendColor, linewidth=3)

// Ù„Ù‚ÙŠÙ…Ø© Ø¹Ø¯Ø¯ÙŠØ© ÙÙŠ Data Window
plot(trendState, title="Trend State (1=Up, -1=Down, 0=Neutral)", display=display.none)
