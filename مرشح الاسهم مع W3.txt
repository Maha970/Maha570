//@version=5
indicator("Ù…Ø±Ø´Ø­ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Wave 3", shorttitle="Advanced Stock Screener + WAVE3", overlay=true, max_bars_back=500)

// ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù… ==========
stock_type = input.string("ÙƒØ¨ÙŠØ±Ø©", "Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…", options=["Ø³Ù†ØªØ§Øª", "ÙƒØ¨ÙŠØ±Ø©"], group="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…", tooltip="Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù… Ù„Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹")

// ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ ==========
show_table = input.bool(true, "Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬", group="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶")
table_position = input.string("middle_right", "Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„", options=["top_left", "top_center", "top_right", "middle_left", "middle_center", "middle_right", "bottom_left", "bottom_center", "bottom_right"], group="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶")
table_size = input.string("normal", "Ø­Ø¬Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„", options=["tiny", "small", "normal", "large"], group="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶")
show_signals_on_chart = input.bool(true, "Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ", group="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶")
table_transparency = input.int(10, "Ø´ÙØ§ÙÙŠØ© Ø§Ù„Ø¬Ø¯ÙˆÙ„ (0-100)", minval=0, maxval=100, group="Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶")

// ========== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Wave 3 ==========
group_wave3 = "ğŸŒŠ ÙƒØ§Ø´Ù Wave 3"

use_wave3 = input.bool(false, "Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒØ§Ø´Ù Wave 3", group=group_wave3)
wave3_mode = input.string("Normal", "Ù†Ù…Ø· Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª", options=["Aggressive", "Normal", "Conservative"], group=group_wave3)
wave3_left = input.int(3, "Pivot Left (Ù‚Ù…Ù… ÙˆÙ‚ÙŠØ¹Ø§Ù†)", minval=1, group=group_wave3)
wave3_right = input.int(3, "Pivot Right (Ù‚Ù…Ù… ÙˆÙ‚ÙŠØ¹Ø§Ù†)", minval=1, group=group_wave3)
wave3_fibMin = input.float(0.38, "Ø£Ù‚Ù„ ØªØµØ­ÙŠØ­ Ù„Ù„Ù…ÙˆØ¬Ø© 2 (ÙÙŠØ¨Ùˆ)", minval=0.1, maxval=0.9, group=group_wave3)
wave3_fibMax = input.float(0.78, "Ø£Ù‚ØµÙ‰ ØªØµØ­ÙŠØ­ Ù„Ù„Ù…ÙˆØ¬Ø© 2 (ÙÙŠØ¨Ùˆ)", minval=0.2, maxval=0.95, group=group_wave3)
wave3_rsiLen = input.int(14, "Ø·ÙˆÙ„ RSI", minval=2, group=group_wave3)
wave3_rsiBuy = input.float(55.0, "Ø­Ø¯ RSI Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¨Ø¯Ø§ÙŠØ© Wave 3", minval=40.0, maxval=80.0, group=group_wave3)
wave3_volLen = input.int(20, "Ù…ØªÙˆØ³Ø· Ø­Ø¬Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„", minval=2, group=group_wave3)
wave3_volMult = input.float(1.3, "Ø§Ù„Ø¶Ø¹Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ÙÙˆÙ„ÙŠÙˆÙ… (Ø£Ø³Ø§Ø³ÙŠ)", minval=1.0, maxval=5.0, group=group_wave3)
show_wave3_labels = input.bool(true, "Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© W3 ØªØ­Øª Ø§Ù„Ø´Ù…Ø¹Ø©ØŸ", group=group_wave3)

// ========== Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© ==========
group_builtin = "ğŸ“ˆ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©"

// MACD
use_macd = input.bool(false, "Ø§Ø³ØªØ®Ø¯Ø§Ù… MACD", group=group_builtin)
macd_fast = input.int(12, "MACD Fast", minval=1, group=group_builtin)
macd_slow = input.int(26, "MACD Slow", minval=1, group=group_builtin)
macd_signal = input.int(9, "MACD Signal", minval=1, group=group_builtin)

// CCI
use_cci = input.bool(false, "Ø§Ø³ØªØ®Ø¯Ø§Ù… CCI", group=group_builtin)
cci_length = input.int(20, "CCI Length", minval=1, group=group_builtin)
cci_overbought = input.float(100, "CCI Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…ÙØ±Ø·", group=group_builtin)
cci_oversold = input.float(-100, "CCI Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…ÙØ±Ø·", group=group_builtin)

// VWAP
use_vwap = input.bool(false, "Ø§Ø³ØªØ®Ø¯Ø§Ù… VWAP", group=group_builtin)
vwap_length = input.int(20, "VWAP Length", minval=1, tooltip="Ø·ÙˆÙ„ ÙØªØ±Ø© Ø­Ø³Ø§Ø¨ VWAP", group=group_builtin)
vwap_sensitivity = input.float(0.5, "VWAP Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© (%)", minval=0.1, maxval=5.0, step=0.1, tooltip="ÙƒÙ„Ù…Ø§ Ù‚Ù„ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø²Ø§Ø¯Øª Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©", group=group_builtin)

// VWMA
use_vwma = input.bool(false, "Ø§Ø³ØªØ®Ø¯Ø§Ù… VWMA", group=group_builtin)
vwma_length = input.int(20, "VWMA Length", minval=1, group=group_builtin)

// EMA Cross (9/12)
use_ema_cross = input.bool(false, "Ø§Ø³ØªØ®Ø¯Ø§Ù… EMA Cross 9/12", group=group_builtin)
ema_fast_length = input.int(9, "EMA Ø§Ù„Ø³Ø±ÙŠØ¹", minval=1, group=group_builtin)
ema_slow_length = input.int(12, "EMA Ø§Ù„Ø¨Ø·ÙŠØ¡", minval=1, group=group_builtin)

// ========== ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù… ==========
get_adjusted_value(base_value, penny_multiplier, large_multiplier) =>
    stock_type == "Ø³Ù†ØªØ§Øª" ? base_value * penny_multiplier : base_value * large_multiplier

// ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
macd_fast_adj = get_adjusted_value(macd_fast, 1.2, 1.0)
macd_slow_adj = get_adjusted_value(macd_slow, 1.3, 1.0)
macd_signal_adj = get_adjusted_value(macd_signal, 1.1, 1.0)

cci_length_adj = get_adjusted_value(cci_length, 1.5, 1.0)
cci_overbought_adj = get_adjusted_value(cci_overbought, 1.3, 1.0)
cci_oversold_adj = get_adjusted_value(cci_oversold, 1.3, 1.0)

vwap_length_adj = get_adjusted_value(vwap_length, 1.4, 1.0)
vwap_sensitivity_adj = get_adjusted_value(vwap_sensitivity, 2.0, 1.0)

vwma_length_adj = get_adjusted_value(vwma_length, 1.3, 1.0)

ema_fast_length_adj = get_adjusted_value(ema_fast_length, 1.2, 1.0)
ema_slow_length_adj = get_adjusted_value(ema_slow_length, 1.1, 1.0)

// ========== Wave 3 Detection Logic ==========
// ØªÙƒÙŠÙŠÙ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ + Ø§Ù„Ù†Ù…Ø·
isScalp = timeframe.isintraday and timeframe.multiplier <= 5
isIntraday = timeframe.isintraday and timeframe.multiplier > 5 and timeframe.multiplier <= 60
isSwingTF = not timeframe.isintraday

// ØªÙƒÙŠÙŠÙ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Wave 3
leftEff = isSwingTF ? 2 : wave3_left
rightEff = isSwingTF ? 2 : wave3_right

float fibMinEff = wave3_fibMin
float fibMaxEff = wave3_fibMax

if isSwingTF
    if wave3_mode == "Aggressive"
        fibMinEff := 0.25
        fibMaxEff := 0.80
    else if wave3_mode == "Normal"
        fibMinEff := 0.30
        fibMaxEff := 0.70
    else if wave3_mode == "Conservative"
        fibMinEff := 0.38
        fibMaxEff := 0.62

float rsiBuyEff = wave3_rsiBuy
float volMultEff = wave3_volMult

if isScalp or isIntraday
    if wave3_mode == "Aggressive"
        rsiBuyEff  := wave3_rsiBuy - 5.0
        volMultEff := wave3_volMult - 0.1
    else if wave3_mode == "Normal"
        rsiBuyEff  := wave3_rsiBuy
        volMultEff := wave3_volMult
    else if wave3_mode == "Conservative"
        rsiBuyEff  := wave3_rsiBuy + 5.0
        volMultEff := wave3_volMult + 0.2
else
    baseRsi  = wave3_rsiBuy - 5.0
    baseRsi  := math.max(45.0, baseRsi)
    baseVol  = wave3_volMult - 0.1
    baseVol  := math.max(1.0, baseVol)

    if wave3_mode == "Aggressive"
        rsiBuyEff  := math.max(40.0, baseRsi - 5.0)
        volMultEff := math.max(1.0, baseVol - 0.1)
    else if wave3_mode == "Normal"
        rsiBuyEff  := baseRsi
        volMultEff := baseVol
    else if wave3_mode == "Conservative"
        rsiBuyEff  := baseRsi + 5.0
        volMultEff := baseVol + 0.2

rsiBuyEff  := math.min(math.max(rsiBuyEff, 35.0), 80.0)
volMultEff := math.max(volMultEff, 1.0)

// Ù…Ø¤Ø´Ø±Ø§Øª Wave 3 Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
rsiVal = ta.rsi(close, wave3_rsiLen)
volMA  = ta.sma(volume, wave3_volLen)

volOk = volume > volMA * volMultEff
momOk = rsiVal > rsiBuyEff

// Ø§Ù„Ø¨ÙŠÙÙˆØªØ§Øª (Ù‚Ù…Ù… ÙˆÙ‚ÙŠØ¹Ø§Ù†)
ph = ta.pivothigh(high, leftEff, rightEff)
pl = ta.pivotlow(low,  leftEff, rightEff)

pivotHighBar = na(ph) ? na : bar_index - rightEff
pivotLowBar  = na(pl) ? na : bar_index - rightEff

// Ø¢Ø®Ø± Ù‚Ø§Ø¹ Ù…ØªÙƒÙˆÙ‘Ù† (Ø³ÙˆÙŠÙ†Øº Ù„Ùˆ)
var float lastSwingLow    = na
var int   lastSwingLowBar = na

if not na(pl)
    lastSwingLow    := pl
    lastSwingLowBar := pivotLowBar

// Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¬Ø§Øª
var int   state        = 0
var float wave1Low     = na
var float wave1High    = na
var int   wave1HighBar = na
var float wave2Low     = na
var int   wave2LowBar  = na

// ØªØ¹Ø±ÙŠÙ Ù…ÙˆØ¬Ø© 1: Ù‚Ø§Ø¹ Ø«Ù… Ù‚Ù…Ø© Ø¨Ø¹Ø¯Ù‡
if not na(ph)
    hasLow = not na(lastSwingLow) and lastSwingLowBar < pivotHighBar
    if hasLow
        wave1Low     := lastSwingLow
        wave1High    := ph
        wave1HighBar := pivotHighBar
        wave2Low     := na
        wave2LowBar  := na
        state        := 1

// ØªØ¹Ø±ÙŠÙ Ù…ÙˆØ¬Ø© 2: ØªØµØ­ÙŠØ­ ÙÙŠ Ù†Ø·Ø§Ù‚ ÙÙŠØ¨Ùˆ Ù…Ù† Ù…ÙˆØ¬Ø© 1
if state == 1 and not na(pl)
    if pivotLowBar > wave1HighBar
        range1  = wave1High - wave1Low
        retrace = range1 > 0 ? (wave1High - pl) / range1 : na
        if not na(retrace) and retrace >= fibMinEff and retrace <= fibMaxEff
            wave2Low    := pl
            wave2LowBar := pivotLowBar
            state       := 2

// Ø´Ø±Ø· Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚ (Ø¨Ø¯Ø§ÙŠØ© Ù…ÙˆØ¬Ø© 3)
float breakPrice = close

if isSwingTF
    if wave3_mode == "Aggressive" or wave3_mode == "Normal"
        breakPrice := high
    else if wave3_mode == "Conservative"
        breakPrice := close
else
    if wave3_mode == "Aggressive"
        breakPrice := high
    else if wave3_mode == "Normal" or wave3_mode == "Conservative"
        breakPrice := close

isSetupValid = state == 2 and not na(wave1High) and not na(wave2Low)

// Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø®Ø§Ù…: Ø§Ø®ØªØ±Ø§Ù‚ + RSI + ÙÙˆÙ„ÙŠÙˆÙ…
w3_raw = isSetupValid and breakPrice > wave1High and momOk and volOk

// Ø¥Ø´Ø§Ø±Ø© Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù…Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
w3_signal = w3_raw and not w3_raw[1]

// Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù†Ø±Ø¬Ø¹ Ù„Ù„Ø­Ø§Ù„Ø© ØµÙØ± Ù„Ù†Ø¨Ø¯Ø£ Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©
if w3_signal
    state := 0

wave3_buy = use_wave3 and w3_signal
wave3_sell = false  // Wave 3 Ù‡Ùˆ Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ ÙÙ‚Ø·

// ========== ØªØ­Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ==========

// MACD
[macd_line, signal_line, _] = ta.macd(close, int(macd_fast_adj), int(macd_slow_adj), int(macd_signal_adj))
macd_buy = use_macd and ta.crossover(macd_line, signal_line)
macd_sell = use_macd and ta.crossunder(macd_line, signal_line)

// CCI
cci_value = ta.cci(close, int(cci_length_adj))
cci_buy = use_cci and cci_value < cci_oversold_adj and cci_value > cci_value[1]
cci_sell = use_cci and cci_value > cci_overbought_adj and cci_value < cci_value[1]

// VWAP
vwap_value = ta.vwap(close)
vwap_sma = ta.sma(vwap_value, int(vwap_length_adj))
price_above_vwap = close > vwap_sma
price_below_vwap = close < vwap_sma
vwap_deviation = math.abs(close - vwap_sma) / vwap_sma * 100
vwap_momentum = ta.change(close, 3)

// ØªØ­Ø³ÙŠÙ† Ø­Ø³Ø§Ø³ÙŠØ© VWAP
vwap_buy_condition = use_vwap and price_above_vwap and vwap_deviation > vwap_sensitivity_adj and vwap_momentum > 0
vwap_sell_condition = use_vwap and price_below_vwap and vwap_deviation > vwap_sensitivity_adj and vwap_momentum < 0

// Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒÙŠØ¯
vwap_volume_filter = volume > ta.sma(volume, 10)
vwap_buy = vwap_buy_condition and vwap_volume_filter
vwap_sell = vwap_sell_condition and vwap_volume_filter

// VWMA
vwma_value = ta.vwma(close, int(vwma_length_adj))
vwma_buy = use_vwma and ta.crossover(close, vwma_value)
vwma_sell = use_vwma and ta.crossunder(close, vwma_value)

// EMA Cross (9/12)
ema_fast = ta.ema(close, int(ema_fast_length_adj))
ema_slow = ta.ema(close, int(ema_slow_length_adj))
ema_cross_buy = use_ema_cross and ta.crossover(ema_fast, ema_slow)
ema_cross_sell = use_ema_cross and ta.crossunder(ema_fast, ema_slow)

// ========== ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ==========
total_buy_signals = (macd_buy ? 1 : 0) + (cci_buy ? 1 : 0) + (vwap_buy ? 1 : 0) + (vwma_buy ? 1 : 0) + (ema_cross_buy ? 1 : 0) + (wave3_buy ? 1 : 0)

total_sell_signals = (macd_sell ? 1 : 0) + (cci_sell ? 1 : 0) + (vwap_sell ? 1 : 0) + (vwma_sell ? 1 : 0) + (ema_cross_sell ? 1 : 0) + (wave3_sell ? 1 : 0)

total_active_indicators = (use_macd ? 1 : 0) + (use_cci ? 1 : 0) + (use_vwap ? 1 : 0) + (use_vwma ? 1 : 0) + (use_ema_cross ? 1 : 0) + (use_wave3 ? 1 : 0)

// Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
final_buy_signal = total_buy_signals > total_sell_signals and total_buy_signals > 0
final_sell_signal = total_sell_signals > total_buy_signals and total_sell_signals > 0

overall_signal = if final_buy_signal
    "ğŸŸ¢ Ø´Ø±Ø§Ø¡ Ù‚ÙˆÙŠ"
else if final_sell_signal
    "ğŸ”´ Ø¨ÙŠØ¹ Ù‚ÙˆÙŠ"
else if total_buy_signals > 0 and total_sell_signals == 0
    "ğŸŸ¢ Ø´Ø±Ø§Ø¡"
else if total_sell_signals > 0 and total_buy_signals == 0
    "ğŸ”´ Ø¨ÙŠØ¹"
else if total_buy_signals == total_sell_signals and total_buy_signals > 0
    "âš ï¸ Ø¥Ø´Ø§Ø±Ø§Øª Ù…ØªØ¶Ø§Ø±Ø¨Ø©"
else
    "ğŸŸ¡ Ø§Ø­ØªÙØ§Ø¸"

// ========== Ø±Ø³Ù… Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ==========
plotshape(show_signals_on_chart and final_buy_signal, style=shape.triangleup, location=location.belowbar, color=color.green, size=size.normal, title="Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡")
plotshape(show_signals_on_chart and final_sell_signal, style=shape.triangledown, location=location.abovebar, color=color.red, size=size.normal, title="Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹")

// Ø±Ø³Ù… Ø¥Ø´Ø§Ø±Ø§Øª Wave 3
plotshape(show_wave3_labels and use_wave3 and w3_signal, title="W3 Label", text="W3", style=shape.labelup, location=location.belowbar, size=size.tiny, color=color.new(color.blue, 0), textcolor=color.white)
plotshape(use_wave3 and w3_signal, title="Wave 3 Start", style=shape.triangleup, location=location.belowbar, size=size.small, color=color.new(color.blue, 0))

// ========== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ==========
if barstate.islast and total_active_indicators > 0 and show_table
    // ØªØ­ÙˆÙŠÙ„ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    table_pos = switch table_position
        "top_left" => position.top_left
        "top_center" => position.top_center
        "top_right" => position.top_right
        "middle_left" => position.middle_left
        "middle_center" => position.middle_center
        "middle_right" => position.middle_right
        "bottom_left" => position.bottom_left
        "bottom_center" => position.bottom_center
        "bottom_right" => position.bottom_right
        => position.middle_right
    
    // ØªØ­ÙˆÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„Ù†Øµ
    text_size_header = switch table_size
        "tiny" => size.tiny
        "small" => size.small
        "normal" => size.normal
        "large" => size.large
        => size.normal
    
    text_size_content = switch table_size
        "tiny" => size.tiny
        "small" => size.tiny
        "normal" => size.small
        "large" => size.normal
        => size.small
    
    // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ
    table_rows = 4 + total_active_indicators  // Ø²ÙŠØ§Ø¯Ø© ØµÙ Ù„Ø¹Ø±Ø¶ Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    var table result_table = table.new(table_pos, 3, table_rows, 
         bgcolor=color.new(color.white, table_transparency), 
         border_width=2, 
         border_color=color.gray,
         frame_width=1,
         frame_color=color.black)
    
    // Ø­Ø°Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚
    if not na(result_table)
        table.delete(result_table)
        result_table := table.new(table_pos, 3, table_rows, 
             bgcolor=color.new(color.white, table_transparency), 
             border_width=2, 
             border_color=color.gray,
             frame_width=1,
             frame_color=color.black)
    
    // Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
    table.cell(result_table, 0, 0, "Ø§Ù„Ù…Ø¤Ø´Ø±", text_color=color.white, bgcolor=color.new(color.blue, 0), text_size=text_size_header)
    table.cell(result_table, 1, 0, "Ø§Ù„Ù‚ÙŠÙ…Ø©", text_color=color.white, bgcolor=color.new(color.blue, 0), text_size=text_size_header)
    table.cell(result_table, 2, 0, "Ø§Ù„Ø¥Ø´Ø§Ø±Ø©", text_color=color.white, bgcolor=color.new(color.blue, 0), text_size=text_size_header)
    
    // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ù…Ø²
    table.cell(result_table, 0, 1, "Ø§Ù„Ø±Ù…Ø²", text_color=color.black, bgcolor=color.new(color.silver, 20), text_size=text_size_content)
    table.cell(result_table, 1, 1, syminfo.ticker, text_color=color.black, bgcolor=color.new(color.silver, 20), text_size=text_size_content)
    table.cell(result_table, 2, 1, str.tostring(close, "#.##"), text_color=color.black, bgcolor=color.new(color.silver, 20), text_size=text_size_content)
    
    // Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…
    type_color = stock_type == "Ø³Ù†ØªØ§Øª" ? color.new(color.orange, 50) : color.new(color.green, 50)
    table.cell(result_table, 0, 2, "Ù†ÙˆØ¹ Ø§Ù„Ø³Ù‡Ù…", text_color=color.black, bgcolor=type_color, text_size=text_size_content)
    table.cell(result_table, 1, 2, stock_type, text_color=color.black, bgcolor=type_color, text_size=text_size_content)
    table.cell(result_table, 2, 2, stock_type == "Ø³Ù†ØªØ§Øª" ? "ğŸª™ Ø³Ù†ØªØ§Øª" : "ğŸ’ ÙƒØ¨ÙŠØ±Ø©", text_color=color.black, bgcolor=type_color, text_size=text_size_content)
    
    // Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©
    overall_color = final_buy_signal ? color.new(color.green, 0) : final_sell_signal ? color.new(color.red, 0) : color.new(color.orange, 0)
    table.cell(result_table, 0, 3, "Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©", text_color=color.white, bgcolor=overall_color, text_size=text_size_content)
    table.cell(result_table, 1, 3, str.tostring(total_buy_signals) + "/" + str.tostring(total_sell_signals), text_color=color.white, bgcolor=overall_color, text_size=text_size_content)
    table.cell(result_table, 2, 3, overall_signal, text_color=color.white, bgcolor=overall_color, text_size=text_size_content)
    
    // Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª
    row_index = 4
    
    if use_macd
        signal_text = macd_buy ? "ğŸŸ¢ Ø´Ø±Ø§Ø¡" : macd_sell ? "ğŸ”´ Ø¨ÙŠØ¹" : "ğŸŸ¡ Ø§Ø­ØªÙØ§Ø¸"
        signal_color = macd_buy ? color.new(color.green, 50) : macd_sell ? color.new(color.red, 50) : color.new(color.orange, 50)
        table.cell(result_table, 0, row_index, "MACD", text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 1, row_index, str.tostring(macd_line, "#.####"), text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 2, row_index, signal_text, text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        row_index += 1
    
    if use_cci
        signal_text = cci_buy ? "ğŸŸ¢ Ø´Ø±Ø§Ø¡" : cci_sell ? "ğŸ”´ Ø¨ÙŠØ¹" : "ğŸŸ¡ Ø§Ø­ØªÙØ§Ø¸"
        signal_color = cci_buy ? color.new(color.green, 50) : cci_sell ? color.new(color.red, 50) : color.new(color.orange, 50)
        table.cell(result_table, 0, row_index, "CCI", text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 1, row_index, str.tostring(cci_value, "#.#"), text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 2, row_index, signal_text, text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        row_index += 1
    
    if use_vwap
        signal_text = vwap_buy ? "ğŸŸ¢ Ø´Ø±Ø§Ø¡" : vwap_sell ? "ğŸ”´ Ø¨ÙŠØ¹" : "ğŸŸ¡ Ø§Ø­ØªÙØ§Ø¸"
        signal_color = vwap_buy ? color.new(color.green, 50) : vwap_sell ? color.new(color.red, 50) : color.new(color.orange, 50)
        table.cell(result_table, 0, row_index, "VWAP", text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 1, row_index, str.tostring(vwap_sma, "#.##"), text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 2, row_index, signal_text, text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        row_index += 1
    
    if use_vwma
        signal_text = vwma_buy ? "ğŸŸ¢ Ø´Ø±Ø§Ø¡" : vwma_sell ? "ğŸ”´ Ø¨ÙŠØ¹" : "ğŸŸ¡ Ø§Ø­ØªÙØ§Ø¸"
        signal_color = vwma_buy ? color.new(color.green, 50) : vwma_sell ? color.new(color.red, 50) : color.new(color.orange, 50)
        table.cell(result_table, 0, row_index, "VWMA", text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 1, row_index, str.tostring(vwma_value, "#.##"), text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 2, row_index, signal_text, text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        row_index += 1
    
    if use_ema_cross
        signal_text = ema_cross_buy ? "ğŸŸ¢ Ø´Ø±Ø§Ø¡" : ema_cross_sell ? "ğŸ”´ Ø¨ÙŠØ¹" : "ğŸŸ¡ Ø§Ø­ØªÙØ§Ø¸"
        signal_color = ema_cross_buy ? color.new(color.green, 50) : ema_cross_sell ? color.new(color.red, 50) : color.new(color.orange, 50)
        table.cell(result_table, 0, row_index, "EMA Cross 9/12", text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 1, row_index, str.tostring(ema_fast, "#.##") + "/" + str.tostring(ema_slow, "#.##"), text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 2, row_index, signal_text, text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        row_index += 1
    
    if use_wave3
        signal_text = wave3_buy ? "ğŸŸ¢ Wave 3" : "ğŸŸ¡ Ø§Ù†ØªØ¸Ø§Ø±"
        signal_color = wave3_buy ? color.new(color.blue, 50) : color.new(color.orange, 50)
        table.cell(result_table, 0, row_index, "Wave 3", text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 1, row_index, str.tostring(rsiVal, "#.#"), text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        table.cell(result_table, 2, row_index, signal_text, text_color=color.black, bgcolor=signal_color, text_size=text_size_content)
        row_index += 1

// ========== Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ==========
alertcondition(final_buy_signal, title="Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡", message="Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")
alertcondition(final_sell_signal, title="Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹", message="Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹ Ù…Ù† Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")
alertcondition(use_wave3 and w3_signal, title="Wave 3 Start", message="Wave 3 Ø¨Ø¯Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø²")