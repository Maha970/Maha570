//@version=5
indicator("Global EMA9/12 + Dynamic VWAP Filter [W/M]", overlay=false)

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ
timeframeInput = input.timeframe("D", title="Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„ÙÙ„ØªØ±")

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯
[closeTF, highTF, lowTF, volumeTF, hlc3TF, timeTF] = request.security(syminfo.tickerid, timeframeInput, [close, high, low, volume, hlc3, time])

// 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ
isWeekly = timeframeInput == "W"
isMonthly = timeframeInput == "M"

// 2. Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ
vwapLookback = isMonthly ? 40 : isWeekly ? 30 : 20
volumeLookback = isMonthly ? 24 : isWeekly ? 16 : 12
atrLookback = isMonthly ? 24 : isWeekly ? 18 : 14
minBarsBetween = isMonthly ? 6 : isWeekly ? 4 : 3

// 3. Ø­Ø³Ø§Ø¨ VWAP ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯
var float cumulativeTPV = na
var float cumulativeVolume = na

typicalPrice = hlc3TF
volumeSum = volumeTF

// Reset VWAP Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù…Ø¹Ø© ÙÙŠ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
isNewBar = ta.change(timeTF)
if na(cumulativeTPV) or isNewBar
    cumulativeTPV := typicalPrice * volumeSum
    cumulativeVolume := volumeSum
else
    cumulativeTPV := cumulativeTPV + typicalPrice * volumeSum
    cumulativeVolume := cumulativeVolume + volumeSum

vwapValue = cumulativeTPV / cumulativeVolume

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
ema9 = ta.ema(closeTF, 9)
ema12 = ta.ema(closeTF, 12)

// 4. Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
// 4.1 ÙÙ„ØªØ± VWAP Ø§Ù„Ù…ØªÙƒÙŠÙ
vwapStdDev = ta.stdev(vwapValue, vwapLookback)
upperVwapBand = vwapValue + vwapStdDev * 0.7
lowerVwapBand = vwapValue - vwapStdDev * 0.5
vwapBullish = closeTF > lowerVwapBand
vwapBearish = closeTF < upperVwapBand

// 4.2 ÙÙ„ØªØ± Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù…ØªÙƒÙŠÙ
volumeAvg = ta.sma(volumeTF, volumeLookback)
volumeThreshold = volumeAvg * (isMonthly ? 0.6 : isWeekly ? 0.75 : 1.0)
volumeFilter = volumeTF > volumeThreshold

// 4.3 ÙÙ„ØªØ± Ø§Ù„ØªÙ‚Ù„Ø¨ (ATR)
atrValue = ta.atr(atrLookback)
atrAvg = ta.sma(atrValue, atrLookback)
volatilityFilter = atrValue > atrAvg * (isMonthly ? 0.5 : isWeekly ? 0.6 : 0.7)

// 5. Ø´Ø±ÙˆØ· Ø§Ù„ØªÙ‚Ø§Ø·Ø¹ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
bullishCross = ta.crossover(ema9, ema12) and 
     closeTF > ema9 and 
     vwapBullish and 
     volumeFilter and 
     volatilityFilter

bearishCross = ta.crossunder(ema9, ema12) and 
     closeTF < ema9 and 
     vwapBearish and 
     volumeFilter and 
     volatilityFilter

// 6. ØªØªØ¨Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
var int lastBuySignal = na
var int lastSellSignal = na
var bool hadBuyBeforeSell = false

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
if bullishCross
    lastBuySignal := bar_index
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ¹ Ø³Ø§Ø¨Ù‚ ÙˆÙ‡Ø°Ø§ Ø´Ø±Ø§Ø¡ Ø¨Ø¹Ø¯Ù‡ØŒ Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø³Ø¬Ù„
    if not na(lastSellSignal) and bar_index > lastSellSignal
        hadBuyBeforeSell := true

if bearishCross
    lastSellSignal := bar_index
    // Ø¹Ù†Ø¯ Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù†ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø´Ø±Ø§Ø¡ Ù‚Ø¨Ù„Ù‡Ø§
    hadBuyBeforeSell := not na(lastBuySignal) and lastBuySignal < lastSellSignal

// 7. Ø´Ø±Ø· Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ¹ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø´Ø±Ø§Ø¡ Ø³Ø§Ø¨Ù‚
validBuyAfterSell = bullishCross and 
     not na(lastSellSignal) and 
     bar_index > lastSellSignal and 
     (bar_index - lastSellSignal) >= minBarsBetween and 
     hadBuyBeforeSell

// 8. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
var table filterTable = table.new(position.top_right, 2, 5, 
     bgcolor=color.white, border_width=1, border_color=color.gray)

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
if barstate.islast
    table.cell(filterTable, 0, 0, "Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ:", 
         text_color=color.black, bgcolor=color.lime)
    table.cell(filterTable, 1, 0, timeframeInput, 
         text_color=color.black, bgcolor=color.lime)
    
    table.cell(filterTable, 0, 1, "Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡:", 
         text_color=color.black, bgcolor=color.white)
    buyText = na(lastBuySignal) ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯" : str.tostring(lastBuySignal)
    table.cell(filterTable, 1, 1, buyText, 
         text_color=color.black, bgcolor=color.white)
    
    table.cell(filterTable, 0, 2, "Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø© Ø¨ÙŠØ¹:", 
         text_color=color.black, bgcolor=color.white)
    sellText = na(lastSellSignal) ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯" : str.tostring(lastSellSignal)
    table.cell(filterTable, 1, 2, sellText, 
         text_color=color.black, bgcolor=color.white)
    
    table.cell(filterTable, 0, 3, "Ø´Ø±Ø§Ø¡ Ù‚Ø¨Ù„ Ø¨ÙŠØ¹:", 
         text_color=color.black, bgcolor=color.white)
    hadBuyText = hadBuyBeforeSell ? "Ù†Ø¹Ù…" : "Ù„Ø§"
    table.cell(filterTable, 1, 3, hadBuyText, 
         text_color=color.black, bgcolor=color.white)
    
    if validBuyAfterSell
        table.cell(filterTable, 0, 4, "ğŸ¯ Ø§Ù„Ø­Ø§Ù„Ø©:", 
             text_color=color.white, bgcolor=color.green)
        table.cell(filterTable, 1, 4, "Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡", 
             text_color=color.white, bgcolor=color.green)
    else
        table.cell(filterTable, 0, 4, "â³ Ø§Ù„Ø­Ø§Ù„Ø©:", 
             text_color=color.black, bgcolor=color.yellow)
        table.cell(filterTable, 1, 4, "ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±", 
             text_color=color.black, bgcolor=color.yellow)

// 9. Ø¥Ù†Ø°Ø§Ø±Ø§Øª - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø³Ø§Ù„Ø© Ø«Ø§Ø¨ØªØ©
alertcondition(validBuyAfterSell, title="Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ø¨Ø¹Ø¯ Ø¨ÙŠØ¹", 
     message="Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ ØªØ±Ù†Ø¯ Ù‡Ø¨ÙˆØ·")

// 10. Ø§Ø³ØªØ®Ø¯Ø§Ù… alert Ø¹Ø§Ø¯ÙŠ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† alertcondition Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
if validBuyAfterSell
    alert("Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ø¨Ø¹Ø¯ Ø¨ÙŠØ¹ Ø¹Ù„Ù‰ " + timeframeInput + " - " + syminfo.ticker, alert.freq_once_per_bar)

// 11. Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ù…
plotshape(validBuyAfterSell, title="Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ø¨Ø¹Ø¯ Ø¨ÙŠØ¹", 
     style=shape.triangleup, location=location.bottom, 
     color=color.green, size=size.normal)

// 12. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø±Ø³Ù…
plot(validBuyAfterSell ? 1 : 0, "Ø¥Ø´Ø§Ø±Ø© Ø§Ù„ÙÙ„ØªØ±", 
     color=color.green, linewidth=2)

// 13. Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­
if barstate.islast and validBuyAfterSell
    debugText = "ğŸ¯ Ø¥Ø´Ø§Ø±Ø© Ø´Ø±Ø§Ø¡ Ø¨Ø¹Ø¯ Ø¨ÙŠØ¹\n" +
         "Ø§Ù„Ø¥Ø·Ø§Ø±: " + timeframeInput + 
         "\nØ¢Ø®Ø± Ø´Ø±Ø§Ø¡: " + str.tostring(lastBuySignal) + 
         "\nØ¢Ø®Ø± Ø¨ÙŠØ¹: " + str.tostring(lastSellSignal) + 
         "\nØ§Ù„Ø´Ù…Ø¹Ø§Øª Ù…Ù†Ø° Ø§Ù„Ø¨ÙŠØ¹: " + str.tostring(bar_index - lastSellSignal)
    label.new(bar_index, 0, debugText, 
         style=label.style_label_up, color=color.green, textcolor=color.white)