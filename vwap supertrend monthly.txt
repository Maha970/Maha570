//@version=5
indicator("VWAPSUPERTREND Ø§Ù„Ø´Ù‡Ø±ÙŠ", overlay=true)

// ðŸŸ¢ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³ÙˆØ¨Ø±ØªØ±Ù†Ø¯
length = input.int(10, "SuperTrend Length")
factor = input.float(3.0, "SuperTrend Factor")

// ðŸŸ¢ Ø­Ø³Ø§Ø¨ ATR
atr = ta.atr(length)

// ðŸŸ¢ Ø­Ø³Ø§Ø¨ Ø®Ø·ÙˆØ· Ø§Ù„Ø³ÙˆØ¨Ø±ØªØ±Ù†Ø¯
up = hl2 - (factor * atr)
down = hl2 + (factor * atr)

var float supertrend = na
var int dir = 1

if na(supertrend)
    supertrend := close > up ? down : up
    dir := close > up ? 1 : -1
else
    if dir == 1
        supertrend := close > supertrend ? math.max(supertrend, up) : down
        dir := close > supertrend ? 1 : -1
    else
        supertrend := close < supertrend ? math.min(supertrend, down) : up
        dir := close < supertrend ? -1 : 1

// ðŸŸ¢ Ø§Ù„ÙÙŠÙˆØ§Ø¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ
isNewMonth = ta.change(time("M"))
var float sumPV = na
var float sumVol = na
var float vwap = na

vol = volume == 0 ? 1 : volume

if isNewMonth
    sumPV := hlc3 * vol
    sumVol := vol
else
    sumPV += hlc3 * vol
    sumVol += vol

vwap := sumPV / sumVol

// ðŸŸ¢ Ø§Ù„Ø¯Ù…Ø¬: Ø®Ø· ÙˆØ§Ø­Ø¯ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ø³Ø¹Ø± ÙÙˆÙ‚ Ø§Ù„Ø§Ø«Ù†ÙŠÙ† Ø£Ùˆ ØªØ­Øª Ø§Ù„Ø§Ø«Ù†ÙŠÙ†
bothUp = close > vwap and close > supertrend
bothDown = close < vwap and close < supertrend
combinedLine = (bothUp or bothDown) ? (vwap + supertrend)/2 : na

combinedColor = bothUp ? color.green : bothDown ? color.red : na

plot(combinedLine, color=combinedColor, linewidth=2, title="ðŸ“ˆ Ø®Ø· Ù…Ø¯Ù…Ø¬ - ÙÙŠÙˆØ§Ø¨ Ø´Ù‡Ø±ÙŠ + Ø³ÙˆØ¨Ø±ØªØ±Ù†Ø¯")